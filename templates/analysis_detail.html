<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analysis Details - Bitcoin Vulnerability Scanner</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="{{ url_for('static', filename='style.css') }}" rel="stylesheet">
</head>
<body>
    <div class="container-fluid">
        <header class="terminal-header">
            <h1><i class="fas fa-search"></i> ANALYSIS DETAILS</h1>
            <p class="terminal-subtitle">Block: {{ analysis.block_input }}</p>
        </header>

        <div class="row">
            <div class="col-md-4">
                <div class="terminal-panel">
                    <h3><i class="fas fa-info-circle"></i> ANALYSIS SUMMARY</h3>
                    <table class="table table-dark">
                        <tr>
                            <td>Block Input:</td>
                            <td><code>{{ analysis.block_input }}</code></td>
                        </tr>
                        <tr>
                            <td>Analysis Key:</td>
                            <td><code>{{ analysis.analysis_key }}</code></td>
                        </tr>
                        <tr>
                            <td>Status:</td>
                            <td>
                                <span class="badge bg-{{ 'success' if analysis.status == 'completed' else 'warning' }}">
                                    {{ analysis.status.upper() }}
                                </span>
                            </td>
                        </tr>
                        <tr>
                            <td>Total Vulnerabilities:</td>
                            <td><span class="badge bg-danger">{{ analysis.vulnerability_count }}</span></td>
                        </tr>
                        <tr>
                            <td>Started:</td>
                            <td>{{ analysis.started_at.strftime('%Y-%m-%d %H:%M:%S') if analysis.started_at else 'N/A' }}</td>
                        </tr>
                        <tr>
                            <td>Completed:</td>
                            <td>{{ analysis.completed_at.strftime('%Y-%m-%d %H:%M:%S') if analysis.completed_at else 'N/A' }}</td>
                        </tr>
                    </table>

                    <div class="mt-3">
                        <a href="{{ url_for('export_analysis', analysis_key=analysis.analysis_key) }}" 
                           class="btn btn-success">
                            <i class="fas fa-download"></i> Export Results
                        </a>
                        <a href="{{ url_for('index') }}" class="btn btn-secondary">
                            <i class="fas fa-arrow-left"></i> Back to Dashboard
                        </a>
                    </div>
                </div>
            </div>

            <div class="col-md-8">
                <div class="terminal-panel">
                    <h3><i class="fas fa-bug"></i> VULNERABILITY DETAILS</h3>
                    
                    {% for vulnerability in vulnerabilities %}
                    <div class="vulnerability-item">
                        <div class="d-flex justify-content-between align-items-center">
                            <h4>
                                <span class="badge bg-{{ 'danger' if vulnerability.risk_level == 'CRITICAL' else 'warning' if vulnerability.risk_level == 'HIGH' else 'info' }}">
                                    {{ vulnerability.vulnerability_type.replace('_', ' ').title() }}
                                </span>
                            </h4>
                            <span class="badge bg-{{ 'danger' if vulnerability.risk_level == 'CRITICAL' else 'warning' if vulnerability.risk_level == 'HIGH' else 'info' }}">
                                {{ vulnerability.risk_level }}
                            </span>
                        </div>

                        {% if vulnerability.txid %}
                        <p><strong>Transaction ID:</strong> 
                            <code class="clickable-hash explorer-link" onclick="openTransactionExplorer('{{ vulnerability.txid }}')">{{ vulnerability.txid }}</code>
                            <i class="fas fa-external-link-alt ms-2" style="font-size: 0.8em; color: #00bfff;"></i>
                        </p>
                        {% endif %}

                        {% if vulnerability.details %}
                        {% set details = vulnerability.details | from_json %}
                        <div class="vulnerability-details">
                            <p><strong>Description:</strong> {{ details.get('description', 'N/A') }}</p>
                            
                            {% if details.get('r_value') %}
                            <p><strong>R Value:</strong> <code class="clickable-hash" onclick="copyToClipboard('{{ details.get('r_value') }}')">{{ details.get('r_value') }}</code></p>
                            {% endif %}
                            
                            {% if details.get('s_value') %}
                            <p><strong>S Value:</strong> <code class="clickable-hash" onclick="copyToClipboard('{{ details.get('s_value') }}')">{{ details.get('s_value') }}</code></p>
                            {% endif %}
                            
                            {% if details.get('recovery_method') %}
                            <p><strong>Recovery Method:</strong> {{ details.get('recovery_method') }}</p>
                            {% endif %}
                        </div>
                        {% endif %}

                        {% if vulnerability.private_key %}
                        <div class="private-key-section">
                            <h5><i class="fas fa-key"></i> Recovered Private Key</h5>
                            <p><strong>Private Key:</strong> <code class="clickable-hash critical" onclick="copyToClipboard('{{ vulnerability.private_key }}')">{{ vulnerability.private_key }}</code></p>
                            
                            {% if vulnerability.addresses %}
                            {% set addresses = vulnerability.addresses | from_json %}
                            <h6>Generated Addresses:</h6>
                            <ul>
                                {% for addr_type, address in addresses.items() %}
                                <li>
                                    <strong>{{ addr_type.replace('_', ' ').title() }}:</strong> 
                                    <code class="clickable-hash" onclick="copyToClipboard('{{ address }}')">{{ address }}</code>
                                </li>
                                {% endfor %}
                            </ul>
                            {% endif %}
                        </div>
                        {% endif %}

                        <small class="text-muted">Found: {{ vulnerability.created_at.strftime('%Y-%m-%d %H:%M:%S') }}</small>
                    </div>
                    <hr>
                    {% endfor %}

                    {% if not vulnerabilities %}
                    <div class="text-center py-4">
                        <i class="fas fa-shield-alt fa-3x text-success"></i>
                        <h4 class="mt-3">No Vulnerabilities Detected</h4>
                        <p>This block appears to be secure with no detectable cryptographic vulnerabilities.</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(function() {
                // Show success feedback
                const toast = document.createElement('div');
                toast.className = 'alert alert-success position-fixed';
                toast.style.top = '20px';
                toast.style.right = '20px';
                toast.style.zIndex = '9999';
                toast.innerHTML = '<i class="fas fa-check"></i> Copied to clipboard!';
                document.body.appendChild(toast);
                
                setTimeout(() => {
                    toast.remove();
                }, 2000);
            });
        }
    </script>
</body>
</html>
